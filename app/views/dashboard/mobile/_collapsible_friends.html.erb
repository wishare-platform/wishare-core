<!-- Mobile Collapsible Friends Section -->
<div class="bg-white/95 dark:bg-gray-800/95 backdrop-blur-sm rounded-xl shadow-sm border border-rose-100 dark:border-gray-700"
     data-controller="mobile-collapsible"
     data-mobile-collapsible-key-value="friends">

  <!-- Collapsible Header (Always Visible) -->
  <div class="p-4 cursor-pointer"
       data-action="click->mobile-collapsible#toggle">
    <div class="flex items-center justify-between">
      <div class="flex items-center">
        <svg class="w-5 h-5 mr-2 text-rose-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"></path>
        </svg>
        <h3 class="heading-sub text-gray-900 dark:text-gray-100">
          <%= t('dashboard.sidebar.friends_list.title') %>
        </h3>
      </div>

      <div class="flex items-center gap-2">
        <!-- Friends count badge -->
        <% friends_count = @user.connections.accepted.count %>
        <% if friends_count > 0 %>
          <span class="bg-blue-500 text-white text-xs font-medium px-2 py-1 rounded-full">
            <%= friends_count %>
          </span>
        <% end %>

        <!-- Chevron icon -->
        <svg class="w-5 h-5 text-gray-400 transition-transform duration-200"
             data-mobile-collapsible-target="chevron"
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>

    <!-- Preview of top friends (when collapsed) -->
    <div class="mt-3 flex items-center gap-2"
         data-mobile-collapsible-target="preview">
      <%
        # Get top 3 connected friends for preview
        connected_users = []
        @user.connections.accepted.includes(:partner).limit(3).each do |connection|
          connected_users << connection.partner
        end
        @user.inverse_connections.accepted.includes(:user).limit(3).each do |connection|
          connected_users << connection.user
        end
        preview_friends = connected_users.uniq.first(3)
      %>

      <% if preview_friends.any? %>
        <div class="flex -space-x-2">
          <% preview_friends.each do |friend| %>
            <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-white dark:border-gray-800">
              <%= user_avatar_or_initials(friend, size: 'w-full h-full text-xs') %>
            </div>
          <% end %>
        </div>
        <span class="text-sm text-gray-500 dark:text-gray-400">
          <%= friends_count > 3 ? "+#{friends_count - 3} more" : "" %>
        </span>
      <% else %>
        <span class="text-sm text-gray-500 dark:text-gray-400">
          <%= t('dashboard.sidebar.friends_list.no_friends_yet') %>
        </span>
      <% end %>
    </div>
  </div>

  <!-- Collapsible Content -->
  <div class="hidden"
       data-mobile-collapsible-target="content">
    <div class="px-4 pb-4">
      <!-- Render the existing friends list content -->
      <%= render 'dashboard/sidebar/friends_list_content' %>
    </div>
  </div>
</div>